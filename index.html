<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Meme Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* --------------------------------------------------
           LIGHT MODE
        -------------------------------------------------- */
        body {
            background: #eef1f5;
            color: #111;
            font-family: "Segoe UI", Arial, sans-serif;
            transition: 0.3s ease;
            padding-top: 5px;
        }

        /* Main Card */
        .main-card {
            border-radius: 10px;
            background: white;
            transition: 0.3s ease;
        }

        /* Left panel border beautify */
        #left-panel {
            border-right: 1px solid #ddd;
        }

        /* Canvas */
        #meme-canvas {
            width: 100%;
            max-width: 100%;
            background: #fff;
            border-radius: 10px;
            border: 1px solid #000;
            margin-bottom: 10px;
            cursor: move;
            touch-action: none;
        }

        /* Form elements */
        .form-control, .form-select {
            border-radius: 6px;
            padding: 6px;
            font-size: 14px;
        }

        /* Buttons */
        button {
            border-radius: 6px !important;
            font-size: 12px !important;
            padding: 8px !important;
        }

        /* Text position controls */
        .position-controls {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 10px;
        }

        .slider-group {
            margin-bottom: 6px;
        }

        .slider-group label {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 3px;
            display: block;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .slider-value {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            background: #e9ecef;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px;
        }

        /* Color controls */
        .color-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            margin-top: 8px;
        }

        .color-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .color-group label {
            font-size: 11px;
            font-weight: 600;
        }

        .color-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        /* Drag instructions */
        .drag-instructions {
            background: #e7f3ff;
            border-radius: 4px;
            padding: 4px;
            margin-bottom: 8px;
            text-align: center;
            font-size: 10px;
            border: 1px solid #b3d9ff;
        }

        /* Text element styles */
        .text-element {
            position: absolute;
            cursor: move;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            z-index: 5;
            padding: 5px;
            border-radius: 3px;
            background: rgba(0,0,0,0.1);
            border: 1px dashed transparent;
            transition: border 0.2s;
        }

        .text-element:hover, .text-element.active {
            border-color: #007bff;
        }

        .text-element-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #007bff;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            z-index: 10;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .text-element-handle.size {
            background: #ffc107;
        }

        .text-element-handle.delete {
            background: #dc3545;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        /* --------------------------------------------------
           DARK MODE
        -------------------------------------------------- */
        body.dark {
            background: #0f0f0f;
            color: white;
        }

        /* Card */
        body.dark .main-card {
            background: #1b1b1b;
            color: white;
            border-color: #444;
        }

        /* Left panel border */
        body.dark #left-panel {
            border-right: 1px solid #555;
        }

        /* Form elements */
        body.dark .form-control,
        body.dark .form-select {
            background: #262626 !important;
            color: #fff !important;
            border: 1px solid #555 !important;
        }

        /* Buttons */
        body.dark button {
            background: #222 !important;
            color: #fff !important;
            border: 1px solid #666 !important;
        }

        /* Canvas border */
        body.dark #meme-canvas {
            border-color: #fafafa;
            background: #1d1d1d;
        }

        /* Position controls in dark mode */
        body.dark .position-controls {
            background: #2d2d2d;
        }

        body.dark .slider-value {
            background: #444;
            color: white;
        }

        body.dark .color-preview {
            border-color: #666;
        }

        body.dark .drag-instructions {
            background: #1a365d;
            border-color: #2d3748;
            color: #e2e8f0;
        }

        /* --------------------------------------------------
           DARK MODE TOGGLE
        -------------------------------------------------- */
        #toggle-dark {
            display: none;
        }

        #darkToggle {
            width: 60px;
            height: 30px;
            border-radius: 999px;
            background: #F3F3F3;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.05) inset;
            cursor: pointer;
            position: relative;
            display: block;
        }

        #darkToggle .circle {
            width: 24px;
            height: 24px;
            border-radius: 99px;
            background: white;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.05),
            -5px -5px 15px rgba(0, 0, 0, 0.05) inset;
            position: absolute;
            top: 50%;
            left: 0%;
            transform: translate(10%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: 0.3s;
        }

        #darkToggle svg {
            width: 12px;
            position: absolute;
            transition: 0.3s;
        }

        #darkToggle .sun {
            color: #FFD600;
            margin-top: 0%;
            opacity: 1;
        }

        #darkToggle .moon {
            margin-top: -150%;
            color: white;
            opacity: 0;
        }

        /* Dark mode styles for toggle */
        body.dark #darkToggle {
            background: #1F1F21;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.5) inset;
        }

        body.dark #darkToggle .circle {
            left: 100%;
            transform: translate(-110%, -50%);
            background: #2C2C2F;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5),
            -5px -5px 15px rgba(0, 0, 0, 0.5) inset;
        }

        body.dark #darkToggle .circle .sun {
            margin-top: 150%;
            opacity: 0;
        }

        body.dark #darkToggle .circle .moon {
            margin-top: 0%;
            opacity: 1;
        }

        #darkToggle:active .circle {
            width: 28px;
        }

        /* --------------------------------------------------
           TEMPLATE GALLERY STYLES
        -------------------------------------------------- */
        .template-gallery {
            margin-bottom: 15px;
        }

        .template-section {
            margin-bottom: 10px;
        }

        .template-section h6 {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 3px;
            font-size: 12px;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            max-height: 120px;
            overflow-y: auto;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .template-item {
            cursor: pointer;
            border-radius: 4px;
            overflow: hidden;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            background: white;
        }

        .template-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .template-item.active {
            border-color: #007bff;
            box-shadow: 0 0 0 1px rgba(0,123,255,0.25);
        }

        .template-img {
            width: 100%;
            height: 50px;
            object-fit: cover;
            display: block;
        }

        .template-name {
            font-size: 9px;
            text-align: center;
            padding: 3px 1px;
            background: rgba(0,0,0,0.8);
            color: white;
            margin: 0;
            font-weight: 500;
            line-height: 1.1;
        }

        .template-search {
            margin-bottom: 10px;
        }

        .upload-section {
            background: #e7f3ff;
            border-radius: 6px;
            padding: 8px;
            margin-top: 10px;
            border: 1px dashed #007bff;
        }

        .upload-section h6 {
            color: #007bff;
            margin-bottom: 6px;
            font-size: 12px;
        }

        /* Template gallery dark mode */
        body.dark .template-grid {
            background: #2d2d2d;
            border-color: #555;
        }

        body.dark .template-section h6 {
            color: #adb5bd;
            border-bottom-color: #555;
        }

        body.dark .template-item {
            background: #333;
        }

        body.dark .upload-section {
            background: #1a365d;
            border-color: #2d3748;
        }

        body.dark .upload-section h6 {
            color: #63b3ed;
        }

        /* --------------------------------------------------
           RESPONSIVE STYLES
        -------------------------------------------------- */
        @media (max-width: 575px) {
            .container {
                padding-left: 5px;
                padding-right: 5px;
            }
            
            header {
                flex-direction: column;
                gap: 5px;
                text-align: center;
                margin-bottom: 10px !important;
            }
            
            header h1 {
                font-size: 1.1rem !important;
                margin-bottom: 0 !important;
            }
            
            .main-card {
                padding: 8px !important;
                border-radius: 8px;
            }
            
            #left-panel {
                border-right: none;
                border-bottom: 1px solid #ddd;
                padding-bottom: 10px;
                margin-bottom: 10px;
            }
            
            .form-control, .form-select {
                padding: 5px;
                font-size: 14px !important;
                border-radius: 4px;
                margin-bottom: 5px;
            }
            
            button {
                font-size: 11px !important;
                padding: 6px !important;
                margin-bottom: 5px;
            }
            
            #meme-canvas {
                max-height: 200px;
                border-radius: 8px;
            }
            
            #darkToggle {
                width: 50px;
                height: 25px;
            }
            
            #darkToggle .circle {
                width: 20px;
                height: 20px;
            }
            
            #darkToggle svg {
                width: 10px;
            }
            
            .template-grid {
                grid-template-columns: repeat(2, 1fr);
                max-height: 100px;
                gap: 4px;
                padding: 4px;
            }
            
            .template-img {
                height: 40px;
            }
            
            .template-name {
                font-size: 8px;
                padding: 2px 1px;
            }
            
            .drag-instructions {
                font-size: 9px;
                padding: 3px;
                margin-bottom: 6px;
            }
            
            .text-element-handle {
                width: 25px;
                height: 25px;
            }
            
            .slider-group label {
                font-size: 10px;
            }
            
            .slider-value {
                min-width: 25px;
                font-size: 9px;
            }
            
            .color-preview {
                width: 25px;
                height: 25px;
            }
            
            .position-controls {
                padding: 6px;
                margin-bottom: 8px;
            }
            
            .upload-section {
                padding: 6px;
                margin-top: 8px;
            }
            
            h3 {
                font-size: 1rem !important;
                margin-bottom: 10px !important;
            }
        }

        /* Prevent zoom on input focus for mobile */
        @media (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }

        /* Improved touch scrolling */
        .template-grid {
            -webkit-overflow-scrolling: touch;
        }

        /* Better button touch targets for mobile */
        @media (max-width: 768px) {
            .btn {
                min-height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Mobile-specific text size adjustments */
        .mobile-text-sm {
            font-size: 0.8rem !important;
        }

        .mobile-text-xs {
            font-size: 0.7rem !important;
        }

        /* Zoom controls */
        .zoom-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            border-radius: 4px;
            padding: 5px;
            display: flex;
            gap: 5px;
            z-index: 20;
        }

        .zoom-btn {
            width: 30px;
            height: 30px;
            border-radius: 3px;
            background: #007bff;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        .zoom-value {
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            padding: 0 5px;
            min-width: 40px;
            justify-content: center;
        }

        /* Text elements panel */
        .text-elements-panel {
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .text-elements-panel h6 {
            font-size: 12px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .text-element-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 5px;
            margin-bottom: 3px;
            background: white;
            border-radius: 3px;
            border: 1px solid #dee2e6;
            cursor: pointer;
        }

        .text-element-item.active {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .text-element-preview {
            flex: 1;
            font-size: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .text-element-actions {
            display: flex;
            gap: 3px;
        }

        .text-element-action {
            width: 18px;
            height: 18px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            cursor: pointer;
            border: none;
        }

        .text-element-action.edit {
            background: #007bff;
            color: white;
        }

        .text-element-action.delete {
            background: #dc3545;
            color: white;
        }

        /* Dark mode for new elements */
        body.dark .text-elements-panel {
            background: #2d2d2d;
        }

        body.dark .text-element-item {
            background: #333;
            border-color: #555;
            color: white;
        }

        body.dark .text-element-item.active {
            background: #1a365d;
            border-color: #2d3748;
        }

        /* Pinch zoom indicators */
        .pinch-hint {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 9px;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div class="container py-1 py-md-3">

    <header class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-2 mb-md-3">
        <h1 class="fw-bold display-5 text-center text-md-start mb-1 mb-md-0 mobile-text-sm">üé® Meme Generator</h1>
        <div class="d-flex align-items-center">
            <input type="checkbox" id="toggle-dark">
            <label for="toggle-dark" id="darkToggle">
                <div class="circle">
                    <svg class="sun" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 18a6 6 0 100-12 6 6 0 000 12z"/>
                    </svg>

                    <svg class="moon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 12.79A9 9 0 0111.21 3a7 7 0 108.58 8.58 9.05 9.05 0 011.21 1.21z"/>
                    </svg>
                </div>
            </label>
        </div>
    </header>

    <div class="card main-card shadow-lg p-1 p-md-3">
        <h3 class="mb-2 mb-md-3 fw-semibold text-center text-md-start mobile-text-sm">Create Your Meme</h3>

        <div class="row g-2 g-md-3">

            <!-- Left Controls -->
            <div class="col-md-4 pe-md-3 border-end" id="left-panel">

                <!-- Template Gallery -->
                <label class="form-label fw-bold mobile-text-sm">Choose Template</label>
                <div class="template-search">
                    <input type="text" id="templateSearch" class="form-control" placeholder="Search..." style="font-size: 14px;">
                </div>
                
                <div class="template-gallery">
                    <div class="template-section">
                        <h6 class="mobile-text-sm">Popular Templates</h6>
                        <div class="template-grid" id="templateGrid">
                            <!-- Templates will be loaded by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="template-section">
                        <h6 class="mobile-text-sm">My Uploads</h6>
                        <div class="template-grid" id="userTemplatesGrid">
                            <!-- User templates will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Upload Section -->
                <div class="upload-section">
                    <h6 class="mobile-text-sm">üì§ Upload Template</h6>
                    <input type="file" id="uploadTemplate" class="form-control mb-1" accept="image/*" style="font-size: 14px;">
                    <input type="text" id="templateNameInput" class="form-control mb-1" placeholder="Template name" style="font-size: 14px;">
                    <button onclick="addUserTemplate()" class="btn btn-outline-primary w-100 py-1">Add Template</button>
                </div>

                <!-- Text Elements Panel -->
                <div class="text-elements-panel">
                    <h6 class="mobile-text-sm">Text Elements</h6>
                    <div id="textElementsList">
                        <!-- Text elements will be added here -->
                    </div>
                    <button onclick="addTextElement()" class="btn btn-sm btn-outline-primary w-100 mt-2">+ Add Text</button>
                </div>

                <!-- Text Controls -->
                <div class="position-controls">
                    <h6 class="fw-bold mb-2 mobile-text-sm">Text Controls</h6>
                    
                    <div class="drag-instructions mobile-text-xs">
                        üí° Drag text boxes to move, drag handles to resize
                    </div>
                    
                    <div class="slider-group">
                        <label class="mobile-text-sm">Text Size:</label>
                        <div class="slider-container">
                            <input type="range" id="textSize" class="form-range" min="10" max="100" value="30">
                            <span id="textSizeValue" class="slider-value">30px</span>
                        </div>
                    </div>

                    <div class="slider-group">
                        <label class="mobile-text-sm">Stroke Width:</label>
                        <div class="slider-container">
                            <input type="range" id="strokeWidth" class="form-range" min="0" max="10" value="2">
                            <span id="strokeWidthValue" class="slider-value">2px</span>
                        </div>
                    </div>

                    <!-- Color Controls -->
                    <div class="color-controls">
                        <div class="color-group">
                            <label class="mobile-text-sm">Text Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="textColor" value="#ffffff" class="form-control form-control-color" style="width: 35px; height: 35px;">
                                <div id="textColorPreview" class="color-preview" style="background-color: #ffffff;"></div>
                            </div>
                        </div>
                        
                        <div class="color-group">
                            <label class="mobile-text-sm">Stroke Color:</label>
                            <div class="color-input-group">
                                <input type="color" id="strokeColor" value="#000000" class="form-control form-control-color" style="width: 35px; height: 35px;">
                                <div id="strokeColorPreview" class="color-preview" style="background-color: #000000;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <button onclick="drawMeme()" class="btn btn-primary w-100 mb-1 py-1 fw-semibold">Update</button>
                <button onclick="downloadMeme()" class="btn btn-success w-100 py-1 fw-semibold">Download</button>
            </div>

            <!-- Canvas -->
            <div class="col-md-8 text-center position-relative pinch-container">
                <canvas id="meme-canvas" class="border shadow rounded-3"></canvas>
                <div class="pinch-hint">Pinch to zoom</div>
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                    <div class="zoom-value" id="zoomValue">100%</div>
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                </div>
                <!-- Text elements will be added here by JavaScript -->
            </div>

        </div>
    </div>

</div>

<script>
    const canvas = document.getElementById("meme-canvas");
    const ctx = canvas.getContext("2d");
    let currentImage = new Image();

    // Text elements array
    let textElements = [];
    let activeTextElement = null;
    
    // Canvas zoom and pan
    let canvasScale = 1.0;
    let canvasOffsetX = 0;
    let canvasOffsetY = 0;
    let isPanning = false;
    let startPanX, startPanY;

    // Check if mobile device
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    }

    // Meme templates data
    const memeTemplates = [
        { name: "Drake", url: "https://i.imgflip.com/30b1gx.jpg" },
        { name: "Doge", url: "https://i.imgflip.com/4t0m5.jpg" },
        { name: "Mocking Spongebob", url: "https://i.imgflip.com/1otk96.jpg" },
        { name: "Two Buttons", url: "https://i.imgflip.com/1g8my4.jpg" },
        { name: "Change My Mind", url: "https://i.imgflip.com/24y43o.jpg" },
        { name: "Woman Yelling at Cat", url: "https://i.imgflip.com/345v97.jpg" },
        { name: "Distracted Boyfriend", url: "https://i.imgflip.com/1ur9b0.jpg" },
        { name: "Left Exit 12", url: "https://i.imgflip.com/22bdq6.jpg" },
        { name: "Running Away Balloon", url: "https://i.imgflip.com/261o3j.jpg" },
        { name: "Winnie the Pooh", url: "https://i.imgflip.com/2ybua0.jpg" }
    ];

    // User templates storage
    let userTemplates = JSON.parse(localStorage.getItem('userTemplates')) || [];

    // Dark mode toggle functionality
    document.getElementById("toggle-dark").addEventListener("change", function() {
        document.body.classList.toggle("dark", this.checked);
    });

    // Initialize slider values and event listeners
    function initializeSliders() {
        const sliders = [
            { id: 'textSize', variable: 'textSize', suffix: 'px' },
            { id: 'strokeWidth', variable: 'strokeWidth', suffix: 'px' }
        ];

        sliders.forEach(slider => {
            const sliderElement = document.getElementById(slider.id);
            const valueElement = document.getElementById(slider.id + 'Value');
            
            if (sliderElement && valueElement) {
                sliderElement.value = window[slider.variable];
                valueElement.textContent = window[slider.variable] + slider.suffix;
                
                sliderElement.addEventListener('input', function() {
                    window[slider.variable] = parseInt(this.value);
                    valueElement.textContent = window[slider.variable] + slider.suffix;
                    
                    if (activeTextElement) {
                        activeTextElement.size = window[slider.variable];
                        updateTextElement(activeTextElement.id);
                        drawMeme();
                    }
                });
            }
        });

        // Color pickers
        const textColorPicker = document.getElementById('textColor');
        const strokeColorPicker = document.getElementById('strokeColor');
        const textColorPreview = document.getElementById('textColorPreview');
        const strokeColorPreview = document.getElementById('strokeColorPreview');

        textColorPicker.value = textColor;
        strokeColorPicker.value = strokeColor;
        textColorPreview.style.backgroundColor = textColor;
        strokeColorPreview.style.backgroundColor = strokeColor;

        textColorPicker.addEventListener('input', function() {
            textColor = this.value;
            textColorPreview.style.backgroundColor = textColor;
            
            if (activeTextElement) {
                activeTextElement.color = textColor;
                updateTextElement(activeTextElement.id);
                drawMeme();
            }
        });

        strokeColorPicker.addEventListener('input', function() {
            strokeColor = this.value;
            strokeColorPreview.style.backgroundColor = strokeColor;
            
            if (activeTextElement) {
                activeTextElement.strokeColor = strokeColor;
                updateTextElement(activeTextElement.id);
                drawMeme();
            }
        });
    }

    // Initialize template gallery
    function initializeTemplateGallery() {
        const templateGrid = document.getElementById('templateGrid');
        const userTemplatesGrid = document.getElementById('userTemplatesGrid');
        const templateSearch = document.getElementById('templateSearch');
        
        function loadTemplates(templates, container, filter = '') {
            container.innerHTML = '';
            const filteredTemplates = templates.filter(template => 
                template.name.toLowerCase().includes(filter.toLowerCase())
            );
            
            if (filteredTemplates.length === 0) {
                container.innerHTML = '<div class="text-center w-100 py-2 text-muted" style="font-size: 10px;">No templates found</div>';
                return;
            }
            
            filteredTemplates.forEach((template) => {
                const templateItem = document.createElement('div');
                templateItem.className = 'template-item';
                templateItem.innerHTML = `
                    <img src="${template.url}" alt="${template.name}" class="template-img" loading="lazy" onerror="this.src='https://via.placeholder.com/150/cccccc/666666?text=Error'">
                    <p class="template-name">${template.name}</p>
                `;
                
                templateItem.addEventListener('click', () => {
                    document.querySelectorAll('.template-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    templateItem.classList.add('active');
                    loadImage(template.url);
                });
                
                container.appendChild(templateItem);
            });
        }
        
        loadTemplates(memeTemplates, templateGrid);
        loadTemplates(userTemplates, userTemplatesGrid);
        
        templateSearch.addEventListener('input', (e) => {
            loadTemplates(memeTemplates, templateGrid, e.target.value);
            loadTemplates(userTemplates, userTemplatesGrid, e.target.value);
        });
        
        setTimeout(() => {
            const hasActive = document.querySelector('.template-item.active');
            if (!hasActive && memeTemplates.length > 0) {
                const firstItem = templateGrid.querySelector('.template-item');
                if (firstItem) {
                    firstItem.classList.add('active');
                    loadImage(memeTemplates[0].url);
                }
            }
        }, 100);
    }
    
    // Add user template
    function addUserTemplate() {
        const fileInput = document.getElementById('uploadTemplate');
        const nameInput = document.getElementById('templateNameInput');
        const file = fileInput.files[0];
        const name = nameInput.value.trim();
        
        if (!file) {
            alert('Please select an image file');
            return;
        }
        
        if (!name) {
            alert('Please enter a template name');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const newTemplate = {
                name: name,
                url: e.target.result
            };
            
            userTemplates.push(newTemplate);
            localStorage.setItem('userTemplates', JSON.stringify(userTemplates));
            initializeTemplateGallery();
            fileInput.value = '';
            nameInput.value = '';
            alert('Template added!');
        };
        reader.readAsDataURL(file);
    }

    // Text element functions
    function addTextElement() {
        const id = 'text_' + Date.now();
        const newTextElement = {
            id: id,
            text: 'New Text',
            x: 50,
            y: 50,
            size: parseInt(document.getElementById('textSize').value),
            color: document.getElementById('textColor').value,
            strokeColor: document.getElementById('strokeColor').value,
            strokeWidth: parseInt(document.getElementById('strokeWidth').value)
        };
        
        textElements.push(newTextElement);
        createTextElementDOM(newTextElement);
        setActiveTextElement(id);
        drawMeme();
    }

    function createTextElementDOM(textElement) {
        const textElementsList = document.getElementById('textElementsList');
        
        const elementItem = document.createElement('div');
        elementItem.className = 'text-element-item';
        elementItem.dataset.id = textElement.id;
        
        elementItem.innerHTML = `
            <div class="text-element-preview">${textElement.text}</div>
            <div class="text-element-actions">
                <button class="text-element-action edit" onclick="editTextElement('${textElement.id}')">‚úèÔ∏è</button>
                <button class="text-element-action delete" onclick="deleteTextElement('${textElement.id}')">üóëÔ∏è</button>
            </div>
        `;
        
        elementItem.addEventListener('click', (e) => {
            if (!e.target.classList.contains('text-element-action')) {
                setActiveTextElement(textElement.id);
            }
        });
        
        textElementsList.appendChild(elementItem);
        
        // Create the visual text element on canvas
        createVisualTextElement(textElement);
    }

    function createVisualTextElement(textElement) {
        const canvasContainer = canvas.parentElement;
        
        const textDiv = document.createElement('div');
        textDiv.className = 'text-element';
        textDiv.id = 'visual_' + textElement.id;
        textDiv.style.position = 'absolute';
        textDiv.style.left = textElement.x + '%';
        textDiv.style.top = textElement.y + '%';
        textDiv.style.fontSize = textElement.size + 'px';
        textDiv.style.color = textElement.color;
        textDiv.style.textShadow = `
            ${textElement.strokeWidth}px ${textElement.strokeWidth}px 0 ${textElement.strokeColor},
            -${textElement.strokeWidth}px -${textElement.strokeWidth}px 0 ${textElement.strokeColor},
            ${textElement.strokeWidth}px -${textElement.strokeWidth}px 0 ${textElement.strokeColor},
            -${textElement.strokeWidth}px ${textElement.strokeWidth}px 0 ${textElement.strokeColor}
        `;
        textDiv.textContent = textElement.text;
        textDiv.dataset.id = textElement.id;
        
        // Create resize handle
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'text-element-handle size';
        resizeHandle.style.position = 'absolute';
        resizeHandle.style.right = '-10px';
        resizeHandle.style.bottom = '-10px';
        resizeHandle.innerHTML = '‚ÜîÔ∏è';
        
        // Create delete handle
        const deleteHandle = document.createElement('div');
        deleteHandle.className = 'text-element-handle delete';
        deleteHandle.style.position = 'absolute';
        deleteHandle.style.right = '-10px';
        deleteHandle.style.top = '-10px';
        deleteHandle.innerHTML = '√ó';
        deleteHandle.onclick = (e) => {
            e.stopPropagation();
            deleteTextElement(textElement.id);
        };
        
        textDiv.appendChild(resizeHandle);
        textDiv.appendChild(deleteHandle);
        
        // Add drag functionality
        setupTextElementDrag(textDiv, resizeHandle);
        
        canvasContainer.appendChild(textDiv);
    }

    function setupTextElementDrag(textDiv, resizeHandle) {
        let isDragging = false;
        let isResizing = false;
        let startX, startY;
        let startLeft, startTop, startWidth, startHeight;
        
        // Mouse events for desktop
        textDiv.addEventListener('mousedown', startDrag);
        resizeHandle.addEventListener('mousedown', startResize);
        
        // Touch events for mobile
        textDiv.addEventListener('touchstart', function(e) {
            e.preventDefault();
            startDrag(e.touches[0]);
        }, { passive: false });
        
        resizeHandle.addEventListener('touchstart', function(e) {
            e.preventDefault();
            startResize(e.touches[0]);
        }, { passive: false });
        
        function startDrag(e) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            
            const rect = textDiv.getBoundingClientRect();
            const containerRect = canvas.parentElement.getBoundingClientRect();
            
            startLeft = (rect.left - containerRect.left) / containerRect.width * 100;
            startTop = (rect.top - containerRect.top) / containerRect.height * 100;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', touchDrag, { passive: false });
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchend', stopDrag);
            
            e.preventDefault();
            setActiveTextElement(textDiv.dataset.id);
        }
        
        function startResize(e) {
            isResizing = true;
            startX = e.clientX;
            startY = e.clientY;
            
            const rect = textDiv.getBoundingClientRect();
            startWidth = rect.width;
            startHeight = rect.height;
            
            document.addEventListener('mousemove', resize);
            document.addEventListener('touchmove', touchResize, { passive: false });
            document.addEventListener('mouseup', stopResize);
            document.addEventListener('touchend', stopResize);
            
            e.preventDefault();
            setActiveTextElement(textDiv.dataset.id);
        }
        
        function drag(e) {
            if (!isDragging) return;
            handleDrag(e.clientX, e.clientY);
        }
        
        function touchDrag(e) {
            if (!isDragging) return;
            e.preventDefault();
            handleDrag(e.touches[0].clientX, e.touches[0].clientY);
        }
        
        function resize(e) {
            if (!isResizing) return;
            handleResize(e.clientX, e.clientY);
        }
        
        function touchResize(e) {
            if (!isResizing) return;
            e.preventDefault();
            handleResize(e.touches[0].clientX, e.touches[0].clientY);
        }
        
        function handleDrag(clientX, clientY) {
            const containerRect = canvas.parentElement.getBoundingClientRect();
            const deltaX = clientX - startX;
            const deltaY = clientY - startY;
            
            const deltaXPercent = (deltaX / containerRect.width) * 100;
            const deltaYPercent = (deltaY / containerRect.height) * 100;
            
            const newLeft = Math.max(0, Math.min(100, startLeft + deltaXPercent));
            const newTop = Math.max(0, Math.min(100, startTop + deltaYPercent));
            
            textDiv.style.left = newLeft + '%';
            textDiv.style.top = newTop + '%';
            
            // Update the text element data
            const textElement = textElements.find(te => te.id === textDiv.dataset.id);
            if (textElement) {
                textElement.x = newLeft;
                textElement.y = newTop;
            }
        }
        
        function handleResize(clientX, clientY) {
            const deltaX = clientX - startX;
            
            // Calculate new font size based on width change
            const newFontSize = Math.max(10, Math.min(100, startHeight + deltaX * 0.5));
            
            textDiv.style.fontSize = newFontSize + 'px';
            
            // Update the text element data
            const textElement = textElements.find(te => te.id === textDiv.dataset.id);
            if (textElement) {
                textElement.size = newFontSize;
                document.getElementById('textSize').value = newFontSize;
                document.getElementById('textSizeValue').textContent = newFontSize + 'px';
            }
        }
        
        function stopDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', touchDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchend', stopDrag);
            drawMeme();
        }
        
        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('touchmove', touchResize);
            document.removeEventListener('mouseup', stopResize);
            document.removeEventListener('touchend', stopResize);
            drawMeme();
        }
    }

    function setActiveTextElement(id) {
        // Update active state in DOM
        document.querySelectorAll('.text-element-item').forEach(item => {
            item.classList.remove('active');
        });
        
        document.querySelectorAll('.text-element').forEach(element => {
            element.classList.remove('active');
        });
        
        const elementItem = document.querySelector(`.text-element-item[data-id="${id}"]`);
        const visualElement = document.getElementById(`visual_${id}`);
        
        if (elementItem && visualElement) {
            elementItem.classList.add('active');
            visualElement.classList.add('active');
            
            // Update active text element
            activeTextElement = textElements.find(te => te.id === id);
            
            // Update controls to match active element
            if (activeTextElement) {
                document.getElementById('textSize').value = activeTextElement.size;
                document.getElementById('textSizeValue').textContent = activeTextElement.size + 'px';
                document.getElementById('strokeWidth').value = activeTextElement.strokeWidth;
                document.getElementById('strokeWidthValue').textContent = activeTextElement.strokeWidth + 'px';
                document.getElementById('textColor').value = activeTextElement.color;
                document.getElementById('textColorPreview').style.backgroundColor = activeTextElement.color;
                document.getElementById('strokeColor').value = activeTextElement.strokeColor;
                document.getElementById('strokeColorPreview').style.backgroundColor = activeTextElement.strokeColor;
            }
        }
    }

    function editTextElement(id) {
        const textElement = textElements.find(te => te.id === id);
        if (textElement) {
            const newText = prompt('Edit text:', textElement.text);
            if (newText !== null) {
                textElement.text = newText;
                updateTextElement(id);
                drawMeme();
            }
        }
    }

    function updateTextElement(id) {
        const textElement = textElements.find(te => te.id === id);
        const visualElement = document.getElementById(`visual_${id}`);
        const listItem = document.querySelector(`.text-element-item[data-id="${id}"] .text-element-preview`);
        
        if (textElement && visualElement && listItem) {
            visualElement.textContent = textElement.text;
            visualElement.style.fontSize = textElement.size + 'px';
            visualElement.style.color = textElement.color;
            visualElement.style.textShadow = `
                ${textElement.strokeWidth}px ${textElement.strokeWidth}px 0 ${textElement.strokeColor},
                -${textElement.strokeWidth}px -${textElement.strokeWidth}px 0 ${textElement.strokeColor},
                ${textElement.strokeWidth}px -${textElement.strokeWidth}px 0 ${textElement.strokeColor},
                -${textElement.strokeWidth}px ${textElement.strokeWidth}px 0 ${textElement.strokeColor}
            `;
            
            listItem.textContent = textElement.text;
        }
    }

    function deleteTextElement(id) {
        if (confirm('Are you sure you want to delete this text?')) {
            textElements = textElements.filter(te => te.id !== id);
            
            // Remove from DOM
            const visualElement = document.getElementById(`visual_${id}`);
            const listItem = document.querySelector(`.text-element-item[data-id="${id}"]`);
            
            if (visualElement) visualElement.remove();
            if (listItem) listItem.remove();
            
            // Reset active element
            if (activeTextElement && activeTextElement.id === id) {
                activeTextElement = null;
            }
            
            drawMeme();
        }
    }

    // Zoom functions
    function zoomIn() {
        canvasScale = Math.min(3, canvasScale + 0.1);
        updateZoomDisplay();
        drawMeme();
    }

    function zoomOut() {
        canvasScale = Math.max(0.5, canvasScale - 0.1);
        updateZoomDisplay();
        drawMeme();
    }

    function updateZoomDisplay() {
        document.getElementById('zoomValue').textContent = Math.round(canvasScale * 100) + '%';
    }

    // Setup canvas panning
    function setupCanvasPanning() {
        canvas.addEventListener('mousedown', startPan);
        canvas.addEventListener('touchstart', startPanTouch, { passive: false });
        
        function startPan(e) {
            if (e.button !== 0) return; // Only left mouse button
            isPanning = true;
            startPanX = e.clientX - canvasOffsetX;
            startPanY = e.clientY - canvasOffsetY;
            canvas.style.cursor = 'grabbing';
            
            document.addEventListener('mousemove', pan);
            document.addEventListener('mouseup', stopPan);
        }
        
        function startPanTouch(e) {
            if (e.touches.length === 1) { // Only single touch for panning
                isPanning = true;
                startPanX = e.touches[0].clientX - canvasOffsetX;
                startPanY = e.touches[0].clientY - canvasOffsetY;
                
                document.addEventListener('touchmove', panTouch, { passive: false });
                document.addEventListener('touchend', stopPan);
            }
        }
        
        function pan(e) {
            if (!isPanning) return;
            canvasOffsetX = e.clientX - startPanX;
            canvasOffsetY = e.clientY - startPanY;
            drawMeme();
        }
        
        function panTouch(e) {
            if (!isPanning) return;
            e.preventDefault();
            if (e.touches.length === 1) {
                canvasOffsetX = e.touches[0].clientX - startPanX;
                canvasOffsetY = e.touches[0].clientY - startPanY;
                drawMeme();
            }
        }
        
        function stopPan() {
            isPanning = false;
            canvas.style.cursor = 'move';
            document.removeEventListener('mousemove', pan);
            document.removeEventListener('touchmove', panTouch);
            document.removeEventListener('mouseup', stopPan);
            document.removeEventListener('touchend', stopPan);
        }
    }

    function loadImage(src) {
        currentImage = new Image();
        currentImage.crossOrigin = "anonymous";
        currentImage.src = src;
        currentImage.onload = () => {
            const maxWidth = isMobileDevice() ? (window.innerWidth - 10) : 500;
            const scaleFactor = maxWidth / currentImage.width;
            
            canvas.width = maxWidth;
            canvas.height = currentImage.height * scaleFactor;
            
            // Reset text elements
            textElements = [];
            activeTextElement = null;
            document.getElementById('textElementsList').innerHTML = '';
            document.querySelectorAll('.text-element').forEach(el => el.remove());
            
            // Add default text elements
            addTextElement();
            
            setupCanvasPanning();
            drawMeme();
        };
        
        currentImage.onerror = () => {
            console.error('Failed to load image:', src);
            alert('Failed to load template');
        };
    }

    function drawMeme() {
        if (!currentImage.complete) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Apply zoom and pan transformations
        ctx.save();
        ctx.translate(canvasOffsetX, canvasOffsetY);
        ctx.scale(canvasScale, canvasScale);
        
        // Draw the image
        ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);

        // Draw text elements
        textElements.forEach(textElement => {
            ctx.font = `bold ${textElement.size}px Impact`;
            ctx.fillStyle = textElement.color;
            ctx.strokeStyle = textElement.strokeColor;
            ctx.lineWidth = textElement.strokeWidth;
            ctx.textAlign = "center";
            
            const x = (textElement.x / 100) * canvas.width;
            const y = (textElement.y / 100) * canvas.height;
            
            if (textElement.strokeWidth > 0) {
                ctx.strokeText(textElement.text.toUpperCase(), x, y);
            }
            ctx.fillText(textElement.text.toUpperCase(), x, y);
        });
        
        ctx.restore();
    }

    function downloadMeme() {
        if (!currentImage.complete) {
            alert('Please wait for image to load');
            return;
        }
        
        // Create a temporary canvas for download (without zoom/pan)
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        
        // Draw the image
        tempCtx.drawImage(currentImage, 0, 0, tempCanvas.width, tempCanvas.height);
        
        // Draw text elements
        textElements.forEach(textElement => {
            tempCtx.font = `bold ${textElement.size}px Impact`;
            tempCtx.fillStyle = textElement.color;
            tempCtx.strokeStyle = textElement.strokeColor;
            tempCtx.lineWidth = textElement.strokeWidth;
            tempCtx.textAlign = "center";
            
            const x = (textElement.x / 100) * tempCanvas.width;
            const y = (textElement.y / 100) * tempCanvas.height;
            
            if (textElement.strokeWidth > 0) {
                tempCtx.strokeText(textElement.text.toUpperCase(), x, y);
            }
            tempCtx.fillText(textElement.text.toUpperCase(), x, y);
        });
        
        const link = document.createElement("a");
        link.download = "meme.png";
        link.href = tempCanvas.toDataURL();
        link.click();
    }

    // Handle window resize
    window.addEventListener('resize', function() {
        if (currentImage.src && currentImage.complete) {
            const maxWidth = isMobileDevice() ? (window.innerWidth - 10) : 500;
            const scaleFactor = maxWidth / currentImage.width;
            
            canvas.width = maxWidth;
            canvas.height = currentImage.height * scaleFactor;
            
            drawMeme();
        }
    });

    // Handle orientation change
    window.addEventListener('orientationchange', function() {
        setTimeout(() => {
            if (currentImage.src && currentImage.complete) {
                const maxWidth = isMobileDevice() ? (window.innerWidth - 10) : 500;
                const scaleFactor = maxWidth / currentImage.width;
                
                canvas.width = maxWidth;
                canvas.height = currentImage.height * scaleFactor;
                
                drawMeme();
            }
        }, 100);
    });

    // Initialize everything
    window.addEventListener('load', function() {
        initializeSliders();
        initializeTemplateGallery();
        updateZoomDisplay();
    });
</script>

</body>
</html>
